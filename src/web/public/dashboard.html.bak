<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deep Research Agent - Dashboard</title>
    <style>
      :root {
        --primary: #667eea;
        --primary-dark: #5568d3;
        --accent: #764ba2;
        --danger: #e74c3c;
        --danger-dark: #c0392b;
        --warning: #f39c12;
        --warning-dark: #e67e22;
        --success: #27ae60;
        --bg: #f0f2f5;
        --card: #ffffff;
        --card-hover: #eef1fb;
        --card-alt: #f8f9fa;
        --text: #333333;
        --text-secondary: #555555;
        --text-muted: #888888;
        --border: #e0e0e0;
        --input-bg: #ffffff;
        --modal-actions-bg: #fafbfc;
        --confirm-bg: #ffffff;
        --cancel-bg: #eeeeee;
        --cancel-bg-hover: #dddddd;
        --radius: 8px;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 4px 16px rgba(102, 126, 234, 0.18);
        --transition: 0.25s ease;
      }

      [data-theme="dark"] {
        --bg: #121218;
        --card: #1e1e2a;
        --card-hover: #2a2a3d;
        --card-alt: #252535;
        --text: #e4e4ef;
        --text-secondary: #b0b0c8;
        --text-muted: #7a7a96;
        --border: #2e2e42;
        --input-bg: #252535;
        --modal-actions-bg: #1a1a28;
        --confirm-bg: #1e1e2a;
        --cancel-bg: #2a2a3d;
        --cancel-bg-hover: #353550;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        --shadow-hover: 0 4px 16px rgba(102, 126, 234, 0.25);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* ===== Custom Scrollbars ===== */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
      }
      ::-webkit-scrollbar-corner {
        background: transparent;
      }
      * {
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: var(--bg);
        min-height: 100vh;
        color: var(--text);
      }

      /* ===== Header ===== */
      .header {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--accent) 100%
        );
        color: white;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 12px rgba(102, 126, 234, 0.3);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header h1 {
        font-size: 22px;
        font-weight: 700;
        letter-spacing: -0.3px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-actions {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .user-info {
        font-size: 13px;
        text-align: right;
        opacity: 0.9;
      }
      .user-info .user-email {
        font-size: 11px;
        opacity: 0.7;
      }

      .logout-btn {
        padding: 7px 16px;
        background: rgba(255, 255, 255, 0.18);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 13px;
        transition: background var(--transition);
      }
      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* ===== Container & Grid ===== */
      .container {
        max-width: 1420px;
        margin: 0 auto;
        padding: 24px 28px;
      }

      .grid {
        display: grid;
        grid-template-columns: 340px 1fr;
        gap: 18px;
      }

      .section {
        background: var(--card);
        border-radius: var(--radius);
        padding: 18px;
        box-shadow: var(--shadow);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--primary);
      }
      .section-header h2 {
        font-size: 17px;
        color: var(--text);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .section-header h2 svg {
        flex-shrink: 0;
      }
      .section-header .badge {
        background: var(--primary);
        color: white;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
      }

      /* ===== Topics ===== */
      .topic-list {
        list-style: none;
        min-height: 180px;
        max-height: 360px;
        overflow-y: auto;
      }

      .topic-list .empty-state {
        padding: 26px 14px;
      }

      .topic-list .empty-state p {
        font-size: 13px;
      }

      .topic-item {
        background: var(--card-alt);
        padding: 10px 12px;
        margin-bottom: 8px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 3px solid var(--primary);
        transition: background var(--transition);
      }
      .topic-item:hover {
        background: var(--card-hover);
      }
      .topic-item.inactive {
        opacity: 0.55;
        border-left-color: #ccc;
      }

      .topic-name {
        font-weight: 600;
        font-size: 14px;
      }
      .topic-meta {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .topic-actions {
        display: flex;
        gap: 6px;
        flex-shrink: 0;
      }

      .btn-icon {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition:
          background var(--transition),
          transform var(--transition);
      }
      .btn-icon:hover {
        transform: scale(1.1);
      }
      .btn-icon.toggle {
        background: rgba(243, 156, 18, 0.15);
        color: var(--warning-dark);
      }
      .btn-icon.toggle:hover {
        background: rgba(243, 156, 18, 0.3);
      }
      .btn-icon.delete {
        background: rgba(231, 76, 60, 0.1);
        color: var(--danger);
      }
      .btn-icon.delete:hover {
        background: rgba(231, 76, 60, 0.25);
      }
      .btn-icon.view {
        background: rgba(102, 126, 234, 0.1);
        color: var(--primary);
      }
      .btn-icon.view:hover {
        background: rgba(102, 126, 234, 0.25);
      }

      .add-topic {
        display: flex;
        gap: 8px;
        margin-top: 14px;
      }
      .add-topic input {
        flex: 1;
        padding: 9px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 13px;
        transition: border-color var(--transition);
        outline: none;
        background: var(--input-bg);
        color: var(--text);
      }
      .add-topic input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn-primary {
        padding: 9px 18px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: background var(--transition);
        white-space: nowrap;
      }
      .btn-primary:hover {
        background: var(--primary-dark);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* ===== Theme Toggle ===== */
      .theme-toggle {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 18px;
        transition: background var(--transition);
        color: white;
        line-height: 1;
      }
      .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* ===== Reports ===== */
      .reports-toolbar {
        display: grid;
        grid-template-columns: 150px 1fr auto;
        gap: 8px;
        margin-bottom: 14px;
        align-items: center;
      }
      .reports-toolbar select,
      .reports-toolbar input {
        padding: 7px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 13px;
        outline: none;
        background: var(--input-bg);
        color: var(--text);
      }
      .reports-toolbar select:focus,
      .reports-toolbar input:focus {
        border-color: var(--primary);
      }
      .reports-toolbar .btn-compare {
        padding: 7px 12px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: background var(--transition);
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }
      .reports-toolbar .btn-compare:hover {
        background: var(--primary-dark);
      }
      .reports-toolbar .btn-compare:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .filter-row {
        display: flex;
        gap: 8px;
        grid-column: 1 / -1;
        align-items: center;
        flex-wrap: wrap;
      }
      .filter-row label {
        font-size: 12px;
        color: var(--text-muted);
        white-space: nowrap;
      }
      .filter-row input[type="date"] {
        padding: 5px 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 12px;
        background: var(--input-bg);
        color: var(--text);
        outline: none;
      }
      .filter-row input[type="date"]:focus {
        border-color: var(--primary);
      }
      .filter-row .btn-clear-filters {
        padding: 5px 10px;
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        transition: all var(--transition);
      }
      .filter-row .btn-clear-filters:hover {
        border-color: var(--danger);
        color: var(--danger);
      }

      /* ===== Compare Modal ===== */
      .compare-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0;
        min-height: 300px;
      }
      .compare-panel {
        padding: 20px;
        overflow-y: auto;
        max-height: 65vh;
      }
      .compare-panel:first-child {
        border-right: 1px solid var(--border);
      }
      .compare-panel-header {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .compare-panel-header select {
        padding: 4px 8px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 12px;
        background: var(--input-bg);
        color: var(--text);
        outline: none;
        max-width: 180px;
      }
      .compare-panel-body {
        font-size: 14px;
        line-height: 1.7;
      }
      .compare-panel-body h1,
      .compare-panel-body h2,
      .compare-panel-body h3 {
        margin-top: 16px;
        margin-bottom: 8px;
        color: var(--text);
      }
      .compare-panel-body p {
        margin-bottom: 12px;
      }
      .compare-panel-body a {
        color: var(--primary);
      }
      .compare-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--text-muted);
        font-size: 13px;
      }
      @media (max-width: 700px) {
        .compare-container {
          grid-template-columns: 1fr;
        }
        .compare-panel:first-child {
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
      }

      .reports-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .report-card {
        background: var(--card-alt);
        padding: 14px 16px;
        border-radius: 6px;
        border-left: 3px solid var(--primary);
        cursor: pointer;
        transition:
          transform var(--transition),
          box-shadow var(--transition);
      }
      .report-card:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-hover);
      }

      .report-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }
      .report-title {
        font-weight: 600;
        color: var(--text);
        font-size: 14px;
      }
      .report-topic-badge {
        background: rgba(102, 126, 234, 0.1);
        color: var(--primary);
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 500;
      }
      .report-date {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 6px;
      }
      .report-excerpt {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
        max-height: 42px;
        overflow: hidden;
        display: -webkit-box;
        line-clamp: 2;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
      }
      .empty-state .empty-icon {
        font-size: 40px;
        margin-bottom: 10px;
        opacity: 0.5;
      }
      .empty-state p {
        font-size: 14px;
      }

      /* ===== Loading Spinner ===== */
      .spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(102, 126, 234, 0.2);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-overlay {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 30px;
        gap: 10px;
        color: var(--text-muted);
        font-size: 14px;
      }

      /* ===== Pagination ===== */
      .pagination {
        display: flex;
        gap: 4px;
        margin-top: 16px;
        justify-content: center;
        align-items: center;
      }
      .pagination button {
        padding: 5px 10px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        cursor: pointer;
        border-radius: 5px;
        font-size: 12px;
        transition: all var(--transition);
      }
      .pagination button.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .pagination button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .pagination button:hover:not(:disabled):not(.active) {
        border-color: var(--primary);
        color: var(--primary);
      }
      .pagination .page-info {
        font-size: 12px;
        color: var(--text-muted);
        margin: 0 8px;
      }

      /* ===== Modal ===== */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(3px);
        padding: 20px;
      }
      .modal.active {
        display: flex;
      }

      .modal-content {
        background: var(--card);
        max-width: 800px;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
        padding: 0;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        animation: modalIn 0.2s ease;
      }
      @keyframes modalIn {
        from {
          transform: scale(0.95);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 24px;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--accent) 100%
        );
        color: white;
        border-radius: 12px 12px 0 0;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      .modal-title {
        font-size: 16px;
        font-weight: 600;
      }
      .modal-meta {
        font-size: 11px;
        opacity: 0.8;
        margin-top: 2px;
      }
      .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        font-size: 18px;
        cursor: pointer;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background var(--transition);
      }
      .modal-close:hover {
        background: rgba(255, 255, 255, 0.35);
      }

      .modal-actions {
        display: flex;
        gap: 8px;
        padding: 12px 24px;
        border-bottom: 1px solid var(--border);
        background: var(--modal-actions-bg);
      }
      .modal-actions button {
        padding: 6px 14px;
        font-size: 12px;
        border: 1px solid var(--border);
        border-radius: 5px;
        background: var(--card);
        color: var(--text);
        cursor: pointer;
        transition: all var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }
      .modal-actions button:hover {
        border-color: var(--primary);
        color: var(--primary);
      }

      .modal-body {
        padding: 24px;
        font-size: 14px;
        line-height: 1.7;
      }
      .modal-body h1,
      .modal-body h2,
      .modal-body h3 {
        margin-top: 20px;
        margin-bottom: 10px;
        color: var(--text);
      }
      .modal-body p {
        margin-bottom: 12px;
      }
      .modal-body a {
        color: var(--primary);
      }
      .modal-body ul,
      .modal-body ol {
        margin-left: 20px;
        margin-bottom: 12px;
      }

      /* ===== Toast Notifications ===== */
      .toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 2000;
        display: flex;
        flex-direction: column-reverse;
        gap: 8px;
      }
      .toast {
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        animation: toastIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        max-width: 360px;
      }
      .toast.success {
        background: var(--success);
      }
      .toast.error {
        background: var(--danger);
      }
      .toast.info {
        background: var(--primary);
      }
      @keyframes toastIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: none;
          opacity: 1;
        }
      }

      /* ===== Confirm Dialog ===== */
      .confirm-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 3000;
        justify-content: center;
        align-items: center;
      }
      .confirm-overlay.active {
        display: flex;
      }
      .confirm-box {
        background: var(--confirm-bg);
        padding: 24px;
        border-radius: 12px;
        max-width: 380px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      }
      .confirm-box p {
        margin-bottom: 20px;
        font-size: 14px;
        line-height: 1.5;
        color: var(--text);
      }
      .confirm-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      .confirm-actions button {
        padding: 8px 20px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: background var(--transition);
      }
      .btn-cancel {
        background: var(--cancel-bg);
        color: var(--text);
      }
      .btn-cancel:hover {
        background: var(--cancel-bg-hover);
      }
      .btn-confirm-danger {
        background: var(--danger);
        color: white;
      }
      .btn-confirm-danger:hover {
        background: var(--danger-dark);
      }

      /* ===== Responsive ===== */
      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .topic-list {
          max-height: 300px;
        }
        .reports-toolbar {
          grid-template-columns: 1fr;
        }
        .reports-toolbar .btn-compare {
          justify-content: center;
        }
      }
      @media (max-width: 600px) {
        .header {
          flex-direction: column;
          gap: 12px;
          text-align: center;
          padding: 14px 16px;
        }
        .container {
          padding: 14px 12px;
        }
        .tab-btn {
          padding: 8px 10px;
          font-size: 12px;
        }
      }

      /* ===== Notification Bell ===== */
      .notification-bell {
        position: relative;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius);
        cursor: pointer;
        color: white;
        transition: background var(--transition);
      }
      .notification-bell:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: var(--danger);
        color: white;
        font-size: 10px;
        font-weight: 700;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9px;
        padding: 0 4px;
      }
      .notification-badge.hidden {
        display: none;
      }

      /* ===== Notification Dropdown ===== */
      .notification-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        width: 360px;
        max-height: 420px;
        overflow-y: auto;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        z-index: 200;
      }
      .notification-dropdown.active {
        display: block;
      }
      .notification-dropdown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        font-weight: 600;
        color: var(--text);
      }
      .notification-dropdown-header button {
        font-size: 11px;
        color: var(--primary);
        background: none;
        border: none;
        cursor: pointer;
      }
      .notification-item {
        padding: 10px 16px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background var(--transition);
      }
      .notification-item:hover {
        background: var(--card-hover);
      }
      .notification-item.unread {
        border-left: 3px solid var(--primary);
      }
      .notification-item .notif-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text);
      }
      .notification-item .notif-message {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 2px;
      }
      .notification-item .notif-time {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
      }
      .notification-empty {
        padding: 30px;
        text-align: center;
        color: var(--text-muted);
        font-size: 13px;
      }

      /* ===== Category Tags ===== */
      .category-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
      }
      .category-tag {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 8px;
        font-weight: 500;
        color: white;
        line-height: 1.5;
      }
      .category-tag .remove-tag {
        cursor: pointer;
        opacity: 0.7;
        font-size: 12px;
        line-height: 1;
      }
      .category-tag .remove-tag:hover {
        opacity: 1;
      }

      /* ===== Categories Section ===== */
      .categories-section {
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid var(--border);
      }
      .categories-section h3 {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .category-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }
      .category-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        color: white;
        cursor: pointer;
        transition: opacity var(--transition);
      }
      .category-chip:hover {
        opacity: 0.85;
      }
      .category-chip .delete-cat {
        opacity: 0.7;
        cursor: pointer;
        font-size: 14px;
      }
      .category-chip .delete-cat:hover {
        opacity: 1;
      }
      .add-category {
        display: flex;
        gap: 6px;
        margin-top: 8px;
      }
      .add-category input {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 12px;
        background: var(--input-bg);
        color: var(--text);
        outline: none;
      }
      .add-category input[type="color"] {
        width: 32px;
        padding: 2px;
        cursor: pointer;
      }

      /* ===== Bookmark Button ===== */
      .btn-bookmark {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-muted);
        transition: color var(--transition);
        padding: 4px;
        display: flex;
        align-items: center;
      }
      .btn-bookmark:hover {
        color: var(--warning);
      }
      .btn-bookmark.active {
        color: var(--warning);
      }

      /* ===== Tabs ===== */
      .tab-bar {
        display: flex;
        gap: 2px;
        margin-bottom: 14px;
        border-bottom: 2px solid var(--border);
        overflow-x: auto;
        scrollbar-width: none;
      }

      .tab-bar::-webkit-scrollbar {
        display: none;
      }

      .tab-btn {
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-muted);
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        cursor: pointer;
        transition: all var(--transition);
      }
      .tab-btn:hover {
        color: var(--text);
      }
      .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .tab-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 18px;
        height: 18px;
        margin-left: 6px;
        padding: 0 5px;
        border-radius: 9px;
        font-size: 10px;
        font-weight: 600;
        background: rgba(102, 126, 234, 0.12);
        color: var(--primary);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      /* ===== Summary Cards ===== */
      .summary-card {
        background: var(--card-alt);
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid var(--accent);
        margin-bottom: 12px;
        cursor: pointer;
        transition:
          transform var(--transition),
          box-shadow var(--transition);
      }
      .summary-card:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-hover);
      }
      .summary-card-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
      }
      .summary-card-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text);
      }
      .summary-card-date {
        font-size: 11px;
        color: var(--text-muted);
      }
      .summary-card-topics {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .summary-topic-tag {
        font-size: 10px;
        padding: 1px 6px;
        background: rgba(118, 75, 162, 0.1);
        color: var(--accent);
        border-radius: 8px;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>
        <svg
          width="22"
          height="22"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"
          />
          <path d="M8.5 2h7" />
          <path d="M7 16.5h10" />
        </svg>
        Deep Research Agent
      </h1>
      <div class="header-actions">
        <div class="user-info">
          <span id="user-name">Loading...</span>
          <div class="user-email" id="user-email"></div>
        </div>
        <div style="position: relative">
          <button
            class="notification-bell"
            onclick="toggleNotifications()"
            title="Notifications"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />
              <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" />
            </svg>
            <span class="notification-badge hidden" id="notif-badge">0</span>
          </button>
          <div class="notification-dropdown" id="notif-dropdown">
            <div class="notification-dropdown-header">
              <span>Notifications</span>
              <button onclick="markAllRead()">Mark all read</button>
            </div>
            <div id="notif-list">
              <div class="notification-empty">No notifications</div>
            </div>
          </div>
        </div>
        <button
          class="theme-toggle"
          id="theme-toggle"
          onclick="toggleTheme()"
          title="Toggle dark mode"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
          </svg>
        </button>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="container">
      <div class="grid">
        <!-- Topics Section -->
        <div class="section">
          <div class="section-header">
            <h2>
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                <path
                  d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"
                />
                <path d="M12 11h4" />
                <path d="M12 16h4" />
                <path d="M8 11h.01" />
                <path d="M8 16h.01" />
              </svg>
              Topics
            </h2>
            <span class="badge" id="topics-count">0</span>
          </div>
          <ul class="topic-list" id="topics-list">
            <li class="loading-overlay">
              <span class="spinner"></span> Loading topics...
            </li>
          </ul>
          <div class="add-topic">
            <input
              type="text"
              id="new-topic-name"
              placeholder="Add a new research topic..."
              onkeypress="if (event.key === 'Enter') addTopic();"
              maxlength="200"
            />
            <button class="btn-primary" id="btn-add-topic" onclick="addTopic()">
              Add
            </button>
          </div>

          <div class="categories-section">
            <h3>üè∑Ô∏è Categories</h3>
            <div class="category-list" id="categories-list"></div>
            <div class="add-category">
              <input
                type="text"
                id="new-category-name"
                placeholder="New category..."
                maxlength="50"
              />
              <input
                type="color"
                id="new-category-color"
                value="#667eea"
                title="Pick color"
              />
              <button
                class="btn-primary"
                onclick="addCategory()"
                style="padding: 6px 12px; font-size: 12px"
              >
                Add
              </button>
            </div>
          </div>
        </div>

        <!-- Recent Reports Section -->
        <div class="section">
          <div class="section-header">
            <h2>
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"
                />
                <path d="M14 2v4a2 2 0 0 0 2 2h4" />
                <path d="M10 9H8" />
                <path d="M16 13H8" />
                <path d="M16 17H8" />
              </svg>
              Research Library
            </h2>
          </div>

          <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('reports')">
              Reports <span class="tab-count" id="reports-count">0</span>
            </button>
            <button class="tab-btn" onclick="switchTab('bookmarks')">
              ‚≠ê Bookmarks <span class="tab-count" id="bookmarks-count">0</span>
            </button>
            <button class="tab-btn" onclick="switchTab('summaries')">
              üìä Summaries <span class="tab-count" id="summaries-count">0</span>
            </button>
          </div>
          <div id="tab-reports" class="tab-content active">
            <div class="reports-toolbar">
              <select id="topic-filter" onchange="filterByTopic()">
                <option value="">All Topics</option>
              </select>
              <input
                type="search"
                id="report-search"
                placeholder="Search reports..."
                oninput="debounceSearch()"
                style="flex: 1; min-width: 140px"
              />
              <button
                class="btn-compare"
                id="btn-compare"
                onclick="openCompare()"
                disabled
                title="Select a topic to compare reports"
              >
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M16 3h5v5" />
                  <path d="M8 3H3v5" />
                  <path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3" />
                  <path d="m15 9 6-6" />
                </svg>
                Compare
              </button>
              <div class="filter-row">
                <label>From</label>
                <input
                  type="date"
                  id="filter-date-from"
                  onchange="applyFilters()"
                />
                <label>To</label>
                <input
                  type="date"
                  id="filter-date-to"
                  onchange="applyFilters()"
                />
                <button
                  class="btn-clear-filters"
                  onclick="clearFilters()"
                  title="Clear all filters"
                >
                  <svg
                    width="12"
                    height="12"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M18 6 6 18" />
                    <path d="m6 6 12 12" />
                  </svg>
                  Clear
                </button>
              </div>
            </div>

            <div class="reports-list" id="reports-list">
              <div class="loading-overlay">
                <span class="spinner"></span> Loading reports...
              </div>
            </div>
            <div class="pagination" id="pagination"></div>
          </div>
          <div id="tab-bookmarks" class="tab-content">
            <div id="bookmarks-list" class="reports-list">
              <div class="empty-state">
                <div class="empty-icon">‚≠ê</div>
                <p>
                  No bookmarked reports yet. Bookmark reports to find them
                  quickly!
                </p>
              </div>
            </div>
          </div>
          <div id="tab-summaries" class="tab-content">
            <div id="summaries-list" class="reports-list">
              <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <p>
                  No weekly summaries yet. Summaries are generated every Sunday.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Report Detail Modal -->
    <div
      class="modal"
      id="report-modal"
      onclick="if (event.target === this) closeModal();"
    >
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <div class="modal-title" id="modal-report-title"></div>
            <div class="modal-meta" id="modal-report-meta"></div>
          </div>
          <button class="modal-close" onclick="closeModal()" title="Close">
            &times;
          </button>
        </div>
        <div class="modal-actions">
          <button onclick="copyReportContent()" title="Copy to clipboard">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
              <path
                d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
              />
            </svg>
            Copy
          </button>
          <button
            onclick="deleteCurrentReport()"
            title="Delete report"
            style="color: var(--danger)"
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M3 6h18" />
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
            </svg>
            Delete
          </button>
          <button
            id="btn-modal-bookmark"
            onclick="toggleBookmark()"
            title="Bookmark report"
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z" />
            </svg>
            <span id="bookmark-label">Bookmark</span>
          </button>
        </div>
        <div class="modal-body" id="modal-report-body"></div>
      </div>
    </div>

    <!-- Confirm Dialog -->
    <div class="confirm-overlay" id="confirm-dialog">
      <div class="confirm-box">
        <p id="confirm-message"></p>
        <div class="confirm-actions">
          <button class="btn-cancel" onclick="closeConfirm(false)">
            Cancel
          </button>
          <button class="btn-confirm-danger" onclick="closeConfirm(true)">
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Compare Modal -->
    <div
      class="modal"
      id="compare-modal"
      onclick="if (event.target === this) closeCompare();"
    >
      <div class="modal-content" style="max-width: 1000px">
        <div class="modal-header">
          <div>
            <div class="modal-title" id="compare-title">Compare Reports</div>
            <div class="modal-meta" id="compare-meta">
              Track topic evolution over time
            </div>
          </div>
          <button class="modal-close" onclick="closeCompare()" title="Close">
            &times;
          </button>
        </div>
        <div class="compare-container">
          <div class="compare-panel">
            <div class="compare-panel-header">
              <span>Older report</span>
              <select
                id="compare-select-left"
                onchange="loadComparePanel('left')"
              ></select>
            </div>
            <div class="compare-panel-body" id="compare-body-left">
              <div class="compare-empty">Select a report</div>
            </div>
          </div>
          <div class="compare-panel">
            <div class="compare-panel-header">
              <span>Newer report</span>
              <select
                id="compare-select-right"
                onchange="loadComparePanel('right')"
              ></select>
            </div>
            <div class="compare-panel-body" id="compare-body-right">
              <div class="compare-empty">Select a report</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
      // ===== State =====
      let currentPage = 1;
      const reportsPerPage = 10;
      let currentTopicFilter = "";
      let searchQuery = "";
      let searchTimeout = null;
      let allTopics = [];
      let currentReport = null;
      let confirmResolve = null;
      let compareReports = [];

      // ===== Theme =====
      function initTheme() {
        const saved = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        const theme = saved || (prefersDark ? "dark" : "light");
        applyTheme(theme);
      }

      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        const btn = document.getElementById("theme-toggle");
        if (btn)
          btn.innerHTML =
            theme === "dark"
              ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>'
              : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>';
      }

      function toggleTheme() {
        const current =
          document.documentElement.getAttribute("data-theme") || "light";
        const next = current === "dark" ? "light" : "dark";
        localStorage.setItem("theme", next);
        applyTheme(next);
      }

      // Apply theme immediately to avoid flash
      initTheme();

      // ===== Init =====
      document.addEventListener("DOMContentLoaded", () => {
        checkAuth();
        loadTopics();
        loadReports(1);
        loadCategories();
        loadBookmarks();
        startNotificationPolling();
      });

      // ===== Toast Notifications =====
      function showToast(message, type = "info", duration = 3500) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        const icons = {
          success:
            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>',
          error:
            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>',
          info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
        };
        toast.innerHTML = `<span>${icons[type] || ""}</span><span>${escapeHtml(message)}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
          toast.style.transition = "opacity 0.3s, transform 0.3s";
          toast.style.opacity = "0";
          toast.style.transform = "translateX(100%)";
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // ===== Confirm Dialog =====
      function showConfirm(message) {
        return new Promise((resolve) => {
          confirmResolve = resolve;
          document.getElementById("confirm-message").textContent = message;
          document.getElementById("confirm-dialog").classList.add("active");
        });
      }

      function closeConfirm(result) {
        document.getElementById("confirm-dialog").classList.remove("active");
        if (confirmResolve) {
          confirmResolve(result);
          confirmResolve = null;
        }
      }

      // ===== Auth =====
      async function checkAuth() {
        try {
          const res = await fetch("/auth/user");
          if (!res.ok) {
            // When OIDC is disabled, auth/user returns 401 but dashboard still works
            document.getElementById("user-name").textContent = "Dev Mode";
            document.querySelector(".logout-btn").style.display = "none";
            return;
          }
          const data = await res.json();
          if (!data.authenticated) {
            document.getElementById("user-name").textContent = "Dev Mode";
            document.querySelector(".logout-btn").style.display = "none";
            return;
          }
          document.getElementById("user-name").textContent =
            data.user.name || data.user.email;
          document.getElementById("user-email").textContent = data.user.email;
        } catch (err) {
          document.getElementById("user-name").textContent = "Dev Mode";
          document.querySelector(".logout-btn").style.display = "none";
        }
      }

      // ===== Topics =====
      async function loadTopics() {
        try {
          const res = await fetch("/api/topics");
          const data = await res.json();
          if (!data.success) {
            showToast("Failed to load topics", "error");
            return;
          }

          allTopics = data.data;
          const topicsList = document.getElementById("topics-list");
          topicsList.innerHTML = "";

          // Update stats
          document.getElementById("topics-count").textContent =
            allTopics.length;

          // Update topic filter dropdown
          updateTopicFilter();

          if (allTopics.length === 0) {
            topicsList.innerHTML =
              '<li class="empty-state"><div class="empty-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg></div><p>No topics yet. Add your first research topic below!</p></li>';
            return;
          }

          allTopics.forEach((topic) => {
            const li = document.createElement("li");
            li.className = `topic-item ${!topic.active ? "inactive" : ""}`;
            li.innerHTML = `
              <div>
                <div class="topic-name">${escapeHtml(topic.name)}</div>
                <div class="topic-meta">Created ${formatDate(topic.created_at)} ${!topic.active ? "&bull; Disabled" : ""}</div>
              </div>
              <div class="topic-actions">
                <button class="btn-icon view" onclick="filterReportsByTopic('${escapeAttr(topic.name)}')" title="View reports"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></button>
                <button class="btn-icon toggle" onclick="toggleTopic('${escapeAttr(topic.id)}', ${!topic.active})" title="${topic.active ? "Disable" : "Enable"}">
                  ${topic.active ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>'}
                </button>
                <button class="btn-icon delete" onclick="deleteTopic('${escapeAttr(topic.id)}', '${escapeAttr(topic.name)}')" title="Delete"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
              </div>`;
            topicsList.appendChild(li);
          });
        } catch (err) {
          console.error("Load topics error:", err);
          showToast("Failed to load topics", "error");
        }
      }

      function updateTopicFilter() {
        const select = document.getElementById("topic-filter");
        const currentVal = select.value;
        select.innerHTML = '<option value="">All Topics</option>';
        allTopics.forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t.name;
          opt.textContent = t.name;
          select.appendChild(opt);
        });
        select.value = currentVal;
      }

      async function addTopic() {
        const input = document.getElementById("new-topic-name");
        const name = input.value.trim();
        if (!name) {
          showToast("Please enter a topic name", "error");
          return;
        }

        const btn = document.getElementById("btn-add-topic");
        btn.disabled = true;
        btn.textContent = "...";

        try {
          const res = await fetch("/api/topics", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name }),
          });
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed to add topic", "error");
            return;
          }
          input.value = "";
          showToast(`Topic "${name}" added`, "success");
          loadTopics();
          loadStats();
        } catch (err) {
          showToast("Failed to add topic", "error");
        } finally {
          btn.disabled = false;
          btn.textContent = "Add";
        }
      }

      async function toggleTopic(id, newActive) {
        try {
          const res = await fetch(`/api/topics/${id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ active: newActive }),
          });
          if (!res.ok) {
            showToast("Failed to update topic", "error");
            return;
          }
          showToast(`Topic ${newActive ? "enabled" : "disabled"}`, "success");
          loadTopics();
        } catch (err) {
          showToast("Failed to update topic", "error");
        }
      }

      async function deleteTopic(id, name) {
        const ok = await showConfirm(
          `Delete "${name}" and all its reports? This cannot be undone.`,
        );
        if (!ok) return;
        try {
          const res = await fetch(`/api/topics/${id}`, { method: "DELETE" });
          if (!res.ok) {
            showToast("Failed to delete topic", "error");
            return;
          }
          showToast(`Topic "${name}" deleted`, "success");
          loadTopics();
          loadReports(1);
          loadStats();
        } catch (err) {
          showToast("Failed to delete topic", "error");
        }
      }

      // ===== Reports =====
      async function loadReports(page) {
        currentPage = page;
        const list = document.getElementById("reports-list");
        list.innerHTML =
          '<div class="loading-overlay"><span class="spinner"></span> Loading...</div>';

        try {
          let url = `/api/reports?page=${page}&limit=${reportsPerPage}`;
          if (currentTopicFilter)
            url += `&topic=${encodeURIComponent(currentTopicFilter)}`;

          const dateFrom = document.getElementById("filter-date-from").value;
          const dateTo = document.getElementById("filter-date-to").value;
          const searchVal = document
            .getElementById("report-search")
            .value.trim();

          if (dateFrom) url += `&from=${dateFrom}T00:00:00`;
          if (dateTo) url += `&to=${dateTo}T23:59:59`;
          if (searchVal) url += `&search=${encodeURIComponent(searchVal)}`;

          const res = await fetch(url);
          const data = await res.json();
          if (!data.success) {
            showToast("Failed to load reports", "error");
            return;
          }

          list.innerHTML = "";
          document.getElementById("reports-count").textContent =
            data.data.total;

          const reports = data.data.items;
          if (reports.length === 0) {
            list.innerHTML =
              '<div class="empty-state"><div class="empty-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></div><p>No reports yet. Reports are generated automatically by the research agent.</p></div>';
            document.getElementById("pagination").innerHTML = "";
            return;
          }

          reports.forEach((report) => {
            const excerpt = stripHtml(report.html_content).substring(0, 120);
            const card = document.createElement("div");
            card.className = "report-card";
            card.onclick = () => openReportModal(report);
            card.innerHTML = `
              <div class="report-card-header">
                <span class="report-title">${escapeHtml(report.topic)}</span>
                <span class="report-topic-badge">${formatDate(report.created_at)}</span>
              </div>
              <div class="report-excerpt">${escapeHtml(excerpt)}</div>`;
            list.appendChild(card);
          });

          renderPagination(data.data.total, reportsPerPage);
        } catch (err) {
          console.error("Load reports error:", err);
          list.innerHTML =
            '<div class="empty-state"><p style="color:var(--danger)">Failed to load reports</p></div>';
        }
      }

      function renderPagination(total, perPage) {
        const totalPages = Math.ceil(total / perPage);
        const pag = document.getElementById("pagination");
        pag.innerHTML = "";

        if (totalPages <= 1) return;

        // Prev
        const prev = document.createElement("button");
        prev.textContent = "\u2190";
        prev.disabled = currentPage === 1;
        prev.onclick = () => loadReports(currentPage - 1);
        pag.appendChild(prev);

        // Page info
        const info = document.createElement("span");
        info.className = "page-info";
        info.textContent = `${currentPage} / ${totalPages}`;
        pag.appendChild(info);

        // Next
        const next = document.createElement("button");
        next.textContent = "\u2192";
        next.disabled = currentPage === totalPages;
        next.onclick = () => loadReports(currentPage + 1);
        pag.appendChild(next);
      }

      function filterByTopic() {
        currentTopicFilter = document.getElementById("topic-filter").value;
        document.getElementById("btn-compare").disabled = !currentTopicFilter;
        loadReports(1);
      }

      function filterReportsByTopic(name) {
        document.getElementById("topic-filter").value = name;
        currentTopicFilter = name;
        document.getElementById("btn-compare").disabled = !name;
        loadReports(1);
      }

      function applyFilters() {
        loadReports(1);
      }

      function clearFilters() {
        document.getElementById("filter-date-from").value = "";
        document.getElementById("filter-date-to").value = "";
        document.getElementById("report-search").value = "";
        document.getElementById("topic-filter").value = "";
        currentTopicFilter = "";
        searchQuery = "";
        document.getElementById("btn-compare").disabled = true;
        loadReports(1);
      }

      function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchQuery = document.getElementById("report-search").value.trim();
          loadReports(1);
        }, 400);
      }

      // ===== Report Modal =====
      function openReportModal(report) {
        currentReport = report;
        document.getElementById("modal-report-title").textContent =
          report.topic;
        document.getElementById("modal-report-meta").textContent =
          `Generated on ${new Date(report.created_at).toLocaleString()}`;
        document.getElementById("modal-report-body").innerHTML =
          report.html_content;
        document.getElementById("report-modal").classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        document.getElementById("report-modal").classList.remove("active");
        document.body.style.overflow = "";
        currentReport = null;
      }

      function copyReportContent() {
        if (!currentReport) return;
        const text =
          currentReport.markdown_content ||
          stripHtml(currentReport.html_content);
        navigator.clipboard.writeText(text).then(
          () => showToast("Report copied to clipboard", "success"),
          () => showToast("Failed to copy", "error"),
        );
      }

      async function deleteCurrentReport() {
        if (!currentReport) return;
        const ok = await showConfirm(
          "Delete this report? This cannot be undone.",
        );
        if (!ok) return;
        try {
          const res = await fetch(`/api/reports/${currentReport.id}`, {
            method: "DELETE",
          });
          if (!res.ok) {
            showToast("Failed to delete report", "error");
            return;
          }
          showToast("Report deleted", "success");
          closeModal();
          loadReports(currentPage);
          loadStats();
        } catch (err) {
          showToast("Failed to delete report", "error");
        }
      }

      // ===== Utility =====
      function logout() {
        window.location.href = "/auth/logout";
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function escapeAttr(text) {
        if (!text) return "";
        return text
          .replace(/&/g, "&amp;")
          .replace(/'/g, "&#39;")
          .replace(/"/g, "&quot;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function stripHtml(html) {
        if (!html) return "";
        const div = document.createElement("div");
        div.innerHTML = html;
        return div.textContent || div.innerText || "";
      }

      function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        const now = new Date();
        const diffMs = now - d;
        const diffMin = Math.floor(diffMs / 60000);
        if (diffMin < 1) return "just now";
        if (diffMin < 60) return `${diffMin}m ago`;
        const diffHr = Math.floor(diffMin / 60);
        if (diffHr < 24) return `${diffHr}h ago`;
        const diffDay = Math.floor(diffHr / 24);
        if (diffDay < 7) return `${diffDay}d ago`;
        return d.toLocaleDateString();
      }

      // ===== Report Comparison =====
      async function openCompare() {
        if (!currentTopicFilter) {
          showToast("Select a topic first to compare its reports", "info");
          return;
        }

        try {
          const res = await fetch(
            `/api/topics/${encodeURIComponent(currentTopicFilter)}/reports?limit=50`,
          );
          const data = await res.json();
          if (!data.success || !data.data || data.data.length < 2) {
            showToast("Need at least 2 reports to compare", "info");
            return;
          }

          compareReports = data.data;
          document.getElementById("compare-title").textContent =
            `Compare: ${currentTopicFilter}`;
          document.getElementById("compare-meta").textContent =
            `${compareReports.length} reports available ‚Äî Track topic evolution over time`;

          // Populate selects (older = chronological asc, newer = chronological desc)
          const leftSelect = document.getElementById("compare-select-left");
          const rightSelect = document.getElementById("compare-select-right");
          leftSelect.innerHTML = "";
          rightSelect.innerHTML = "";

          compareReports.forEach((r, i) => {
            const dateStr =
              new Date(r.created_at).toLocaleDateString() +
              " " +
              new Date(r.created_at).toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });
            const opt = `<option value="${i}">${dateStr}</option>`;
            leftSelect.innerHTML += opt;
            rightSelect.innerHTML += opt;
          });

          // Default: oldest on left, newest on right
          leftSelect.value = compareReports.length - 1;
          rightSelect.value = 0;

          loadComparePanel("left");
          loadComparePanel("right");

          document.getElementById("compare-modal").classList.add("active");
          document.body.style.overflow = "hidden";
        } catch (err) {
          console.error("Compare error:", err);
          showToast("Failed to load reports for comparison", "error");
        }
      }

      function loadComparePanel(side) {
        const select = document.getElementById(`compare-select-${side}`);
        const body = document.getElementById(`compare-body-${side}`);
        const idx = parseInt(select.value, 10);
        const report = compareReports[idx];

        if (!report) {
          body.innerHTML = '<div class="compare-empty">Select a report</div>';
          return;
        }

        body.innerHTML = report.html_content;
      }

      function closeCompare() {
        document.getElementById("compare-modal").classList.remove("active");
        document.body.style.overflow = "";
      }

      // ===== Keyboard Shortcuts =====
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (confirmResolve) closeConfirm(false);
          else if (
            document
              .getElementById("compare-modal")
              .classList.contains("active")
          )
            closeCompare();
          else closeModal();
        }
      });

      // ===== State additions =====
      let allCategories = [];
      let currentBookmarks = new Set();
      let notificationsOpen = false;
      let pollInterval = null;

      // ===== Notifications =====
      async function loadNotifications() {
        try {
          const res = await fetch("/api/notifications");
          const data = await res.json();
          if (!data.success) return;

          const { notifications, unreadCount } = data.data;
          const badge = document.getElementById("notif-badge");
          badge.textContent = unreadCount;
          badge.classList.toggle("hidden", unreadCount === 0);

          const list = document.getElementById("notif-list");
          if (notifications.length === 0) {
            list.innerHTML =
              '<div class="notification-empty">No notifications yet</div>';
            return;
          }

          list.innerHTML = notifications
            .map(
              (n) => `
            <div class="notification-item ${!n.read ? "unread" : ""}" onclick="handleNotifClick('${n.id}', '${n.report_id || ""}')">
              <div class="notif-title">${escapeHtml(n.title)}</div>
              <div class="notif-message">${escapeHtml(n.message)}</div>
              <div class="notif-time">${formatDate(n.created_at)}</div>
            </div>
          `,
            )
            .join("");
        } catch (err) {
          console.error("Load notifications error:", err);
        }
      }

      function toggleNotifications() {
        notificationsOpen = !notificationsOpen;
        document
          .getElementById("notif-dropdown")
          .classList.toggle("active", notificationsOpen);
        if (notificationsOpen) loadNotifications();
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", (e) => {
        if (
          notificationsOpen &&
          !e.target.closest(".notification-bell") &&
          !e.target.closest(".notification-dropdown")
        ) {
          notificationsOpen = false;
          document.getElementById("notif-dropdown").classList.remove("active");
        }
      });

      async function handleNotifClick(notifId, reportId) {
        await fetch(`/api/notifications/${notifId}/read`, { method: "PATCH" });
        loadNotifications();
        if (reportId) {
          try {
            const res = await fetch(`/api/reports/${reportId}`);
            const data = await res.json();
            if (data.success && data.data) openReportModal(data.data);
          } catch {}
        }
      }

      async function markAllRead() {
        await fetch("/api/notifications/read-all", { method: "POST" });
        loadNotifications();
        showToast("All notifications marked as read", "success");
      }

      // Start polling for notifications every 30 seconds
      function startNotificationPolling() {
        loadNotifications();
        pollInterval = setInterval(loadNotifications, 30000);
      }

      // ===== Categories =====
      async function loadCategories() {
        try {
          const res = await fetch("/api/categories");
          const data = await res.json();
          if (!data.success) return;
          allCategories = data.data;
          renderCategories();
        } catch (err) {
          console.error("Load categories error:", err);
        }
      }

      function renderCategories() {
        const list = document.getElementById("categories-list");
        if (allCategories.length === 0) {
          list.innerHTML =
            '<span style="font-size:12px;color:var(--text-muted)">No categories yet</span>';
          return;
        }
        list.innerHTML = allCategories
          .map(
            (c) => `
          <span class="category-chip" style="background:${c.color}" title="${escapeHtml(c.name)}">
            ${escapeHtml(c.name)}
            <span class="delete-cat" onclick="event.stopPropagation();deleteCategory('${c.id}')">&times;</span>
          </span>
        `,
          )
          .join("");
      }

      async function addCategory() {
        const nameInput = document.getElementById("new-category-name");
        const colorInput = document.getElementById("new-category-color");
        const name = nameInput.value.trim();
        if (!name) {
          showToast("Category name is required", "error");
          return;
        }

        try {
          const res = await fetch("/api/categories", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, color: colorInput.value }),
          });
          const data = await res.json();
          if (!res.ok) {
            showToast(data.error || "Failed to add category", "error");
            return;
          }
          nameInput.value = "";
          showToast(`Category "${name}" added`, "success");
          loadCategories();
        } catch (err) {
          showToast("Failed to add category", "error");
        }
      }

      async function deleteCategory(id) {
        const ok = await showConfirm(
          "Delete this category? Topics will keep their other categories.",
        );
        if (!ok) return;
        try {
          await fetch(`/api/categories/${id}`, { method: "DELETE" });
          showToast("Category deleted", "success");
          loadCategories();
          loadTopics();
        } catch (err) {
          showToast("Failed to delete category", "error");
        }
      }

      async function assignCategory(topicId, categoryId) {
        try {
          await fetch(`/api/topics/${topicId}/categories`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ category_id: categoryId }),
          });
          loadTopics();
        } catch {}
      }

      async function unassignCategory(topicId, categoryId) {
        try {
          await fetch(`/api/topics/${topicId}/categories/${categoryId}`, {
            method: "DELETE",
          });
          loadTopics();
        } catch {}
      }

      // ===== Bookmarks =====
      async function loadBookmarks() {
        try {
          const res = await fetch("/api/bookmarks");
          const data = await res.json();
          if (!data.success) return;

          currentBookmarks = new Set(data.data.map((b) => b.report_id));
          document.getElementById("bookmarks-count").textContent = String(
            data.data.length,
          );
          const list = document.getElementById("bookmarks-list");

          if (data.data.length === 0) {
            list.innerHTML =
              '<div class="empty-state"><div class="empty-icon">‚≠ê</div><p>No bookmarked reports yet.</p></div>';
            return;
          }

          list.innerHTML = data.data
            .map((b) => {
              if (!b.report) return "";
              const excerpt = stripHtml(b.report.html_content).substring(
                0,
                120,
              );
              return `
              <div class="report-card" onclick="openBookmarkedReport('${b.report_id}')">
                <div class="report-card-header">
                  <span class="report-title">‚≠ê ${escapeHtml(b.report.topic)}</span>
                  <span class="report-topic-badge">${formatDate(b.report.created_at)}</span>
                </div>
                ${b.note ? `<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Note: ${escapeHtml(b.note)}</div>` : ""}
                <div class="report-excerpt">${escapeHtml(excerpt)}</div>
              </div>`;
            })
            .join("");
        } catch (err) {
          console.error("Load bookmarks error:", err);
        }
      }

      async function openBookmarkedReport(reportId) {
        try {
          const res = await fetch(`/api/reports/${reportId}`);
          const data = await res.json();
          if (data.success && data.data) openReportModal(data.data);
        } catch (err) {
          showToast("Failed to load report", "error");
        }
      }

      async function toggleBookmark() {
        if (!currentReport) return;
        const isBookmarked = currentBookmarks.has(currentReport.id);

        try {
          if (isBookmarked) {
            await fetch(`/api/bookmarks/${currentReport.id}`, {
              method: "DELETE",
            });
            currentBookmarks.delete(currentReport.id);
            showToast("Bookmark removed", "info");
          } else {
            await fetch("/api/bookmarks", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ report_id: currentReport.id }),
            });
            currentBookmarks.add(currentReport.id);
            showToast("Report bookmarked", "success");
          }
          updateBookmarkButton();
          loadBookmarks();
        } catch (err) {
          showToast("Bookmark operation failed", "error");
        }
      }

      function updateBookmarkButton() {
        if (!currentReport) return;
        const btn = document.getElementById("btn-modal-bookmark");
        const label = document.getElementById("bookmark-label");
        const isBookmarked = currentBookmarks.has(currentReport.id);
        if (btn) btn.style.color = isBookmarked ? "var(--warning)" : "";
        if (label) label.textContent = isBookmarked ? "Unbookmark" : "Bookmark";
      }

      // ===== Tabs =====
      function switchTab(tab) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        document
          .querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`)
          .classList.add("active");
        document.getElementById(`tab-${tab}`).classList.add("active");

        if (tab === "bookmarks") loadBookmarks();
        if (tab === "summaries") loadSummaries();
      }

      // ===== Weekly Summaries =====
      async function loadSummaries() {
        const list = document.getElementById("summaries-list");
        list.innerHTML =
          '<div class="loading-overlay"><span class="spinner"></span> Loading...</div>';

        try {
          const res = await fetch("/api/summaries");
          const data = await res.json();
          if (!data.success) {
            list.innerHTML =
              '<div class="empty-state"><p>Failed to load summaries</p></div>';
            return;
          }

          document.getElementById("summaries-count").textContent = String(
            data.data.length,
          );

          if (data.data.length === 0) {
            list.innerHTML =
              '<div class="empty-state"><div class="empty-icon">üìä</div><p>No weekly summaries yet. Summaries are generated every Sunday.</p></div>';
            return;
          }

          list.innerHTML = data.data
            .map((s) => {
              let topics = [];
              try {
                topics = JSON.parse(s.topics_covered);
              } catch {}
              return `
              <div class="summary-card" onclick="openSummaryModal('${s.id}', ${JSON.stringify(s.html_content).replace(/'/g, "\\'")})"> 
                <div class="summary-card-header">
                  <span class="summary-card-title">Week of ${s.week_start}</span>
                  <span class="summary-card-date">${formatDate(s.created_at)}</span>
                </div>
                <div class="summary-card-topics">
                  ${topics.map((t) => `<span class="summary-topic-tag">${escapeHtml(t)}</span>`).join("")}
                </div>
              </div>`;
            })
            .join("");
        } catch (err) {
          list.innerHTML =
            '<div class="empty-state"><p style="color:var(--danger)">Failed to load summaries</p></div>';
        }
      }

      function openSummaryModal(id, htmlContent) {
        document.getElementById("modal-report-title").textContent =
          "Weekly Summary";
        document.getElementById("modal-report-meta").textContent =
          "Cross-topic synthesis";
        document.getElementById("modal-report-body").innerHTML = htmlContent;
        document.getElementById("report-modal").classList.add("active");
        document.body.style.overflow = "hidden";
      }

      // ===== Enhanced Topic Loading with Categories =====
      // Override the original openReportModal to update bookmark button
      const _origOpenReportModal = openReportModal;
      openReportModal = function (report) {
        _origOpenReportModal(report);
        updateBookmarkButton();
      };
    </script>
  </body>
</html>
